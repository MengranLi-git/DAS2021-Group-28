---
title: "Properties that influence wine score"
author: 'Group 28: Aishwin Tikku, Mengran Li, Steven Kwok, Shaoquan Li, Shuning Li'

output:
  pdf_document:
    number_sections: no
fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE, comment = NA, fig.pos = 'H')
options(digits = 4)
```

```{r libraries, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
library(tidymodels)
library(GGally)
library(car)
library(sjPlot)
library(skimr)
library(kableExtra)
library(janitor)
```

# Introduction {#sec:Intro}

Wine is an alcoholic drink, produced by various kinds of fermented fruits like grapes, apple or blueberry. There are four kinds of wines, involving white wine, red wine, rose wine and sparkling wine. The difference of wines depends on various kinds of factors, including type of grapes, soil status, and province state. We analysis a data set from the Wine Enthusiast, a famous American wine provider, in this project. Thousands of wines were rated in this data set, where wine with points lower than 80 were filtered.

The aim of our project is discovering properties leading the occurrence of high rated wine, the wine with points larger than 90. The first session visualize the structure, properties, as well as correlations inside the dataset. We, next in order, analysis factors of wine, leading high ranking, thorough the best generalized linear model. Due to the excessive classification of nations, provinces,varieties and wineries, we need to reduce the dimensionality of the data set and build models separately for discussion. Finally, we conclude the entire analysis, as well as discussing what we can do in the future.

# Variables of study and data

## General information

The whole data set has 7 variables and 2000 observations.

```{r echo=FALSE, eval=TRUE, message=FALSE,warning=FALSE}
Data <- read.csv("dataset28.csv")
Data <- Data[, -1]
Data$country <- as.factor(Data$country)
Data$province <- as.factor(Data$province)
Data$title <- as.factor(Data$title)
Data$variety <- as.factor(Data$variety)
Data$winery <- as.factor(Data$winery)
Data$price <- as.integer(Data$price)
my_skim <- skim_with(base = sfl(n = length), numeric = sfl(p0 = NULL, p100 = NULL, hist = NULL))
# my_skim(wine)
print(my_skim(Data))
```

The variables of points and price are continuous while country, province, title, variety and winery are category varibales.

The levels of title and winery are beyond one thousand, which is meaningless to predict, thus we ignore the two variables.

To explore the factors points of wines over 90, the points varaible is transformed as a dummy variable, where Pass means the point is greater than 90 while Fail is not.

```{r}
# Group by points, those greater than 90 are pass, others are fail
Data <- Data %>% mutate(score = ifelse(points > 90, "Pass", "Fail"))
Data$score <- as.factor(Data$score)

```


## Category variables

For the category varibales, we should check the percentages of pass and fail.

```{r echo=FALSE,eval=TRUE,message=FALSE,warning=FALSE}
 Data %>%
  tabyl(country,score)%>%
  adorn_percentages()%>%
  adorn_pct_formatting()%>%
  adorn_ns()
```

We notice that there are several countries who have only few observations.

Chi-squared test is applied to exmain the dependence of country and score.

```{r echo=FALSE,eval=TRUE,message=FALSE,warning=FALSE}
# chi square test
chisq.test(Data$country, Data$score)
```

At the level of 0.05, refuse the null hypotheis, which means there is dependence between country and response variable score.

We conduct statistics on the number of samples according to the type of wine. There are so many levels with rare observations. To deduce dimensions, We classify the types with a sample number of less than 10 as 'others'.

```{r, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
t <- as.matrix(table(Data$variety))
summary(t)
Data$variety <- as.vector(Data$variety)
Data$variety[which(Data$variety %in% row.names(t)[t<11])] = "other"
Data$variety <- as.factor(Data$variety)
```

Simairly, generate a cross-table of variety and score, and test the chi-square.

```{r echo=FALSE,eval=TRUE,message=FALSE,warning=FALSE}
 Data %>%
  tabyl(variety,score)%>%
  adorn_percentages()%>%
  adorn_pct_formatting()%>%
  adorn_ns()
```

```{r echo=FALSE,eval=TRUE,message=FALSE,warning=FALSE}
# chi square test
chisq.test(Data$variety, Data$score)
```

The dependence between variety and score is significant at $\alpha=0.05$.

## Continuous variable

Finally, we compare the distributions of price in different score group. The price in Pass group has a obvious higher mean value than that in Fail group. There is a potential relationship between price and score.

```{r dplot, eval=TRUE, echo=FALSE, fig.align="center", fig.cap="\\label{fig:dplot} Density plot by score", message=FALSE, warning=FALSE, out.width='75%', fig.pos='H'}
ggplot(data = Data) +
  geom_density(aes(price, group = score, fill = score))
```

# Methodology {#sec:FDA}

We conduct a generalized linear model to figure out variables have an influence on whether the point of wine can lie above 90. Our main challenge is that the category variables have too many levels which makes situation tricky.

## Generalized linear model

$$g(\mu)=\sum\beta_ix_i$$
Where $\mu$ is the mean of $Y$. $Y$ is the response variable. $x_i, i=0,\dots,p$ are the explanatory variables. $g$ if the link function. Our response variable is binary, thus the link function takes the form as $log(\frac{\mu}{1-\mu})$. This model is so-called logistic regression model.



## Framework

We aim to develop a reasonable model which contains rare variables. Price is a continuous variable and entry the model directly. We test the variety variable first to examine the significance. Then add the country variable and point out the countries who have better wine. We subset the selected countries and explore the influence of province. After checking the overdispersion, we obtain the best model to explain and predict if the point of a wine is greater than 90, which we call Pass here.

# Result

## Price and variety

We will use the generalised linear model to fit a logistic regression model with score as the response, price and variety as the explanatory variable.

```{r, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
fit1 <- glm(score ~ price + variety,
            data = Data,
            family = binomial(link = "logit"))
fit1 %>% summary()
```
Notice that no variety of wine is significant at the 5% significance level.

Notice that no variety of wine is significant at the 5% significance level.

## Country and province

Similarly, We can use the same method to eliminate interference from too many categories. In order to find this standard, we fit a logistic regression model and check its summary table.

```{r, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
fit2 <- glm(score ~ price + country,
            data = Data,
            family = binomial(link = "logit"))
fit2 %>% summary()
```

We choose variables with p-values less than 0.1. From the summary table, 'New Zealand' and 'Italy' in country and price have a significant influence on the score.

Therefore, we set all countries except 'New Zealand' and 'Italy' as 'others' to make this variable a categorical variable with three levels.

```{r, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}

Data <- Data %>% mutate(
  country = case_when(
    country == "New Zealand" ~ "New Zealand",
    country == "Italy" ~ "Italy",
    !country %in% c( 'New Zealand', 'Italy') ~ "others"
  )
)


```{r}
fit3 <- glm(score ~ price + country,
            data = Data,
            family = binomial(link = "logit"))
summary(fit3)
```

```{r}
AIC(fit2)
AIC(fit3)
```

Compared with the model with all countries, the model with merged counties has a smaller AIC and all variables are significant.

Next, We select 'New Zealand' and 'Italy' to check 'province' variable. Filter samples whose country is either 'New Zealand' or 'Italy' and fit a logistic regression model with score as response, price and province as explanatory variables.

```{r, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
New_Zealand <- Data %>% filter(country == "New Zealand")

glm(score ~ price + province,
    data = New_Zealand,
    family = binomial(link = "logit"),
    ) %>%

  summary()
Italy <- Data %>% filter(country == "Italy")
glm(score ~ price + province,
    data = Italy,
    family = binomial(link = "logit"),
    ) %>%
  summary()
```

From the summary table of the above model, it can be seen that the province has no significant effect on the score.

## Overdispersion

To avoid the overdispersion, we need to compare the value of deviance divided by residual deviance with 1.

```{r, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
deviance(fit3)/df.residual(fit3) 
```

The result is less than 1, there is no overdispersion.

## Odds and prediction

Notice that the coefficients of price, countryNew Zealand, other countries are positive, which means that expensive wine are more likely to pass(points is greater than 90). And the all coefficients are significant (p-value of *`r round(tidy(fit3)[2,2],4)`*, *`r round(tidy(fit3)[3,2],4)`* and *`r round(tidy(fit3)[4,2],4)`*), so we qualify the effect of them.

And the all coefficients are significant (p-value of *`r tidy(fit3)[2,5]`*, *`r tidy(fit3)[3,5]`* and *`r tidy(fit3)[4,5]`*), so we qualify the effect of them.

```{r, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
plot_model(fit3, show.values = TRUE,
           title = "Odds (price)", show.p = TRUE)
```

```{r, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
plot_model(fit3,
           type = "pred", title = "",
           axis.title = c("price", "Probability of pass"))

```

# Coclusion and Future Work {#sec:CFW}

After establishing the generalised linear model and comparing them, we found that the price is the most significant factor on wine scores. In addition, after analysis, we found that Riesling wine or Israel wine are easier to reach 90 points than other varieties of wine.

For discovering factors affecting the quality of wine more accurately, we can combine multiple data sets with details of Wineries. Different model, additionally, will be trained and tested for selecting the best model. The targeted model will be neural network, a self-learning model which can handle large amount of new data. Lastly, we will construct a system, which can help business searching and identifying good model. This application would be useful for assigning price and prevent purchasing unqualified wines.

# Reference {#sec:Ref}

Christina, <https://cellar.asia/wine/what-is-wine/>\`
