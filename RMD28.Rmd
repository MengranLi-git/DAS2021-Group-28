---
title: "Properties that influence wine score"
author: 'Group 28: Aishwin Tikku, Mengran Li, Steven Kwok, Shaoquan Li, Shuning Li'

output:
  pdf_document:
    latex_engine: pdflatex
    number_sections: no
  html_document:
    df_print: paged
fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE, comment = NA, fig.pos = 'H')
options(digits = 4)
```


```{r libraries, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
library(tidymodels)
library(GGally)
library(car)
library(sjPlot)
library(skimr)
library(kableExtra)
library(knitr)
library(janitor)
```


``` {r echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
Data <- read.csv("dataset28.csv")
```


# Introduction {#sec:Intro}

Wine is an alcoholic drink, produced by various kinds of fermented fruits like grapes, apple or blueberry. There are four kinds of wines, involving white wine, red wine, rose wine and sparkling wine. The difference of wines depends on various kinds of factors, including type of grapes, soil status, and province state. We analysis a data set from the Wine Enthusiast, a famous American wine provider, in this project. Thousands of wines were rated in this data set, where wine with points lower than 80 were filtered.

The aim of our project is discovering properties leading the occurrence of high rated wine, the wine with points larger than 90. The first session visualize the structure, properties, as well as correlations inside the dataset. We, next in order, analysis factors of wine, leading high ranking, thorough the best generalized linear model. Finally, we conclude the entire analysis, as well as discussing what we can do in the future.

# Data Structure and Visualisation {#sec:DSV}
The whole data set has 7 factors and 2000 observations.
```{r echo=FALSE, eval=TRUE, message=FALSE,warning=FALSE}
Data <- Data[, -1]
Data$country <- as.factor(Data$country)
Data$province <- as.factor(Data$province)
Data$title <- as.factor(Data$title)
Data$variety <- as.factor(Data$variety)
Data$winery <- as.factor(Data$winery)

# Group by points, those greater than 90 are pass, others are fail
Data <- Data %>% mutate(score = ifelse(points > 90, "Pass", "Fail"))
Data$score <- as.factor(Data$score)
```


```{r his, fig.width=6, fig.height=4, fig.align='center',echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE, fig.cap="\\label{fig:hist} Histogram of Price and Points"}
#### descriptive statistics ####
Data[, c(2, 3)] %>%
  gather(key = "variable", value = "value") %>%
  ggplot() +
  geom_histogram(aes(x = value), fill = "#80C687", color = "#80C687", alpha = 0.8) +
  facet_wrap(~variable, scales = "free")
```

```{r boxplot, eval=TRUE, echo=FALSE, fig.align="center", fig.cap="\\label{fig:box} Boxplot of points by country", message=FALSE, warning=FALSE, out.width='75%', fig.pos='H'}
ggplot(data = Data) +
  geom_boxplot(aes(points, country))
```

```{r echo=FALSE,eval=TRUE,message=FALSE,warning=FALSE}
 Data %>%
  tabyl(country,score)%>%
  adorn_percentages()%>%
  adorn_pct_formatting()%>%
  adorn_ns()
```


```{r echo=FALSE,eval=TRUE,message=FALSE,warning=FALSE}
# chi square test
chisq.test(Data$country, Data$score)
```



```{r dplot, eval=TRUE, echo=FALSE, fig.align="center", fig.cap="\\label{fig:dplot} Density plot by score", message=FALSE, warning=FALSE, out.width='75%', fig.pos='H'}
ggplot(data = Data) +
  geom_density(aes(price, group = score, fill = score))
```



# Methodology {#sec:FDA}
Due to the excessive classification of nations, provinces,varieties and wineries, we need to reduce the dimensionality of the data set and build models separately for discussion.

First of all, we conduct statistics on the number of samples according to the type of wine, and classify the types with a sample number of less than 10 as 'others'.
```{r glm, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
t <- as.matrix(table(Data$variety))

summary(t)

Data$variety <- as.vector(Data$variety)
Data$variety[which(Data$variety %in% row.names(t)[t<11])] = "other"
Data$variety <- as.factor(Data$variety)

```

We will use the generalised linear model to fit a logistic regression model with score as the response, price and variety as the explanatory variable.
```{r glm, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
fit1 <- glm(score ~ price + variety,
            data = Data,
            family = binomial(link = "logit"))
fit1 %>% summary()
```

Similarly, We can use the same method to eliminate interference from too many categories. In order to find this standard, we fit a logistic regression model and check its summary table.
```{r glm, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}

fit2 <- glm(score ~ price + country,
            data = Data,
            family = binomial(link = "logit"))
fit2 %>% summary()
```

We choose variables with p-values less than 0.05. From the summary table, only 'New Zealand' has a significant influence on the score.

So we set all countries except 'New Zealand' as ‘others’ to exclude their influence.
```{r glm, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
Data <- Data %>% mutate(
  country = case_when(
    country == "New Zealand" ~ "New Zealand",
    !country %in% c("New Zealand") ~ "others"
  )
)
```

And fit a logistic regression model with score as the response, price and country as the explanatory variable.
```{r glm, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
fit3 <- glm(score ~ price + country,
            data = Data,
            family = binomial(link = "logit"))

summary(fit3)
```

The AIC value of model3 is smaller than model2. Therefore, we use model 3 for more in-depth research.

Next, We select 'New Zealand' to check 'province' variable. Filter samples whose country is 'New Zealand' and fit a logistic regression model with score as response, price, province and variety as explanatory vaiables.
```{r glm, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
NewZealand <- Data %>% filter(country == "New Zealand")

glm(score ~ price + province + variety,
    data = NewZealand,
    family = binomial(link = "logit")) %>%
  summary()
```

From the summary table of the above model, it can be seen that the province has no significant effect on the score.

To avoid the overdispersion, we need to compare the value of deviance divided by residual deviance with 1.
```{r glm, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
deviance(fit3)/df.residual(fit3) 
```
The result is less than 1, there is no overdispersion.

#####################33
Fit a logistic regression model 4 and 5 to have a further understanding of the relationship between score and price, score and country.

```{r glm, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
fit4 <- glm(score ~ country,
            data = Data,
            family = binomial(link = "logit"))
```

```{r glm, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
plot_model(fit4, show.values = TRUE,
           title = "Odds (Country)", show.p = TRUE)
```

```{r glm, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
plot_model(fit4,
           type = "pred", title = "",
           axis.title = c("Country", "Probability of pass"))
```



```{r glm, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
fit4 <- glm(score ~ price,
            data = Data,
            family = binomial(link = "logit"))
```

```{r glm, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
plot_model(fit5, show.values = TRUE,
           title = "Odds (price)", show.p = TRUE)
```

The probability of pass, id the wine has an unit increase in price. 
```{r glm, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
plot_model(fit5,
           type = "pred", title = "",
           axis.title = c("price", "Probability of pass"))
```


# Coclusion and Future Work {#sec:CFW}

For discovering factors affecting the quality of wine more accurately, we can combine multiple data sets with details of Wineries. Different model, additionally, will be trained and tested for selecting the best model. The targeted model will be neural network, a self-learning model which can handle large amount of new data. Lastly, we will construct a system, which can help business searching and identifying good model. This application would be useful for assigning price and prevent purchasing unqualified wines.

# Reference {#sec:Ref}

 Christina, https://cellar.asia/wine/what-is-wine/`


